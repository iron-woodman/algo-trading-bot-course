# History Loader - Bybit OHLCV (Polars Edition)

Проект для высокопроизводительной выгрузки исторических данных (свечей) с биржи Bybit с использованием **Polars** и многопроцессорности.

## Особенности
- **Высокая производительность:** Использование `Polars` для обработки данных и `multiprocessing` для параллельной загрузки нескольких инструментов.
- **Формат Parquet:** Сохранение данных в формате `.parquet`, что обеспечивает компактное хранение и быструю загрузку.
- **Гибкая конфигурация:** Все параметры (год, таймфрейм, лимиты, пути) вынесены в файл `.env`.
- **Ликвидность:** Автоматическая фильтрация инструментов по суточному объему торгов и сохранение списков в алфавитном (`ALL_COINS.txt`) и отсортированном по ликвидности (`SORTED_COINS.txt`) виде.
- **Целостность данных:** Автоматическое заполнение пропусков в процессе загрузки и проверка на дубликаты.
- **Умная загрузка:** Проверка существования локального файла перед началом выгрузки для предотвращения повторных запросов.
- **Тайминг:** Отслеживание времени начала, окончания и общей длительности процесса выгрузки.

## Технические детали
- **Биржа:** Bybit (USDT Perpetual Futures).
- **Библиотеки:** `ccxt`, `polars`, `pyarrow`, `python-dotenv`.
- **Поддерживаемые таймфреймы:** Любые, поддерживаемые Bybit (`1m`, `5m`, `15m`, `30m`, `1h`, `4h`, `1d` и др.).

## Установка и настройка
1. Создайте виртуальное окружение и установите зависимости:
   ```bash
   python -m venv .venv
   .venv\Scripts\activate  # Windows
   pip install -r requirements.txt
   ```
2. Настройте конфигурацию:
   Скопируйте `.env.example` в `.env` и укажите необходимые значения:
   - `YEAR`: Год для выгрузки.
   - `TIMEFRAME`: Таймфрейм свечей.
   - `MAX_WORKERS`: Количество параллельных процессов (рекомендуется `4` или количество ядер CPU).
   - `BYBIT_API_KEY` / `BYBIT_API_SECRET`: (Опционально) для повышения лимитов запросов.

3. Подготовьте список монет:
   Отредактируйте `TARGET_COINS.txt`, добавив нужные инструменты (по одному на строку, например `BTC/USDT:USDT`).

## Использование

### Загрузка данных
Запустите основной скрипт:
```bash
python main.py
```
Скрипт выполнит:
1. Получение актуального списка инструментов с Bybit.
2. Фильтрацию по минимальному объему и сохранение списков монет.
3. Параллельную загрузку истории для монет из `TARGET_COINS.txt`.
4. Автозаполнение пропусков и сохранение в `data/` в формате `.parquet`.

### Проверка существующих файлов
Для анализа загруженного Parquet-файла используйте `check_parquet.py`:
```bash
python check_parquet.py <путь_к_файлу> <таймфрейм>
```
Пример:
```bash
python check_parquet.py data/BTC_USDT_30m_2025.parquet 30m
```

## Структура проекта
- `main.py` — основной скрипт выгрузки с поддержкой многопроцессорности.
- `ohlc_data_checker.py` — модуль проверки целостности на базе Polars.
- `check_parquet.py` — утилита для ручной проверки файлов.
- `.env` — файл конфигурации.
- `TARGET_COINS.txt` — список монет для загрузки.
- `ALL_COINS.txt` / `SORTED_COINS.txt` — генерируемые списки доступных инструментов.
